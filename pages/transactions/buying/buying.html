<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../../../assets/styles/main.css" />
    <link rel="stylesheet" href="buying.css" />
  </head>
  <body>
    <!-- Modals -->

    <div id="newProductModal" class="modal">
      <form id="newProductForm" class="modal-content">
        <span class="close-modal-btn">&times;</span>
        <h2 class="modal-title">New Product</h2>
        <div class="modal-body">
          <div class="form-group">
            <label for="productDesignation">Product Name</label>
            <input
              type="text"
              id="productDesignation"
              name="productDesignation"
              value="kokaw"
              required
            />
            <small class="form-text">Enter the name of the product.</small>
          </div>

          <div class="form-group">
            <label for="productTaxes">Taxes (%)</label>
            <input
              type="number"
              id="productTaxes"
              name="productTaxes"
              step="0.01"
              min="0"
              value="1.2"
            />
            <small class="form-text">
              Enter the applicable tax percentage.
            </small>
          </div>

          <div class="form-group">
            <label for="subunitsInUnit">Subunits in 1 Unit</label>
            <input
              type="text"
              id="subunitsInUnit"
              name="subunitsInUnit"
              placeholder="e.g., 1 box contains 8 bottles"
              value="6"
              required
            />
            <small class="form-text">
              Specify the number of subunits (e.g., bottles) in one unit (e.g.,
              box).
            </small>
          </div>

          <button
            type="submit"
            onclick="createNewProduct()"
            class="button button-secondary"
          >
            Add Product
          </button>
        </div>
      </form>
    </div>

    <div id="product-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal-btn">&times;</span>
        <h2 class="modal-title">Buy a Product</h2>
        <div class="modal-body">
          <div class="search-container">
            <form id="search-product-form" class="search-form">
              <input
                type="text"
                class="search-input"
                id="search-product-input"
                placeholder="Search for a Product"
                autocomplete="off"
              />
              <button type="submit" id="search-btn" class="search-btn">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="23"
                  viewBox="0 0 22 23"
                  fill="none"
                >
                  <path
                    d="M16.4998 16.9997L13.2515 13.7513M13.2515 13.7513C13.7728 13.2299 14.1864 12.611 14.4686 11.9298C14.7508 11.2486 14.896 10.5184 14.896 9.7811C14.896 9.04376 14.7508 8.31364 14.4686 7.63243C14.1864 6.95121 13.7728 6.33225 13.2515 5.81087C12.7301 5.28949 12.1111 4.87592 11.4299 4.59375C10.7487 4.31158 10.0186 4.16635 9.28125 4.16635C8.54391 4.16635 7.81379 4.31158 7.13258 4.59375C6.45137 4.87592 5.8324 5.28949 5.31102 5.81087C4.25806 6.86384 3.6665 8.29197 3.6665 9.7811C3.6665 11.2702 4.25806 12.6984 5.31102 13.7513C6.36399 14.8043 7.79213 15.3958 9.28125 15.3958C10.7704 15.3958 12.1985 14.8043 13.2515 13.7513Z"
                    stroke="#5B5B5B"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </form>
            <div id="search-product-results" class="search-results hidden">
              <ul id="product-results-list"></ul>
            </div>
          </div>

          <div class="product-form">
            <form id="product-details-form">
              <div class="form-section left">
                <h3>Product Information</h3>
                <div class="form-group">
                  <label for="productId">Product Id</label>
                  <input type="text" id="productId" name="productId" required />
                </div>

                <div class="form-group">
                  <label for="productName">Product Name</label>
                  <input
                    type="text"
                    id="productName"
                    name="productName"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="stockQuantity">Quantity (In Subunit)</label>
                  <input
                    type="number"
                    id="stockQauntity"
                    name="stockQuantity"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="taxes"> Tax (%)</label>
                  <input
                    type="number"
                    id="taxes"
                    name="taxes"
                    step="0.01"
                    required
                  />
                </div>
              </div>

              <div class="form-section right">
                <h3>Product Information</h3>

                <div class="top">
                  <div class="form-group quantity-group">
                    <!-- <label>Quantity</label> -->
                    <div class="quantity-row">
                      <div class="quantity-col">
                        <label for="quantity">Quantity</label>
                        <input type="text" id="quantity" name="quantity" />
                      </div>
                      <span>* <span id="quantityUnit">01</span> =</span>
                      <div class="quantity-col">
                        <label for="subUnits">Sub Units</label>
                        <input type="text" id="subUnits" name="subUnits" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="bottom">
                  <div class="form-section buying-section">
                    <h3>Buying Information</h3>
                    <div class="form-group">
                      <label for="buyingPrice">Buying Price</label>
                      <input
                        type="number"
                        id="buyingPrice"
                        name="buyingPrice"
                        step="0.01"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="totalBuyingPrice">Total Buying Price</label>
                      <input
                        type="number"
                        id="totalBuyingPrice"
                        name="totalBuyingPrice"
                        readonly
                      />
                    </div>
                  </div>

                  <div class="form-section selling-section">
                    <h3>Selling Information</h3>

                    <div class="form-group">
                      <label for="sellingPrice">Selling Price</label>
                      <input
                        type="number"
                        id="sellingPrice"
                        name="sellingPrice"
                        step="0.01"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="totalSellingPrice">Total Selling Price</label>
                      <input
                        type="number"
                        id="totalSellingPrice"
                        name="totalSellingPrice"
                        readonly
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div class="button-group-wrapper">
                <div class="button-group">
                  <button
                    type="submit"
                    class="button button-secondary"
                    id="add-to-list-btn"
                  >
                    Add to Purchase List
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <footer></footer>
      </div>
    </div>

    <!-- End Of Modals -->

    <h1>Buying Page</h1>

    <button data-modal="newProductModal" class="button button-secondary">
      Create New Product
    </button>
    <button data-modal="product-modal" class="button button-secondary">
      buy
    </button>

    <main class="main-container">
      <section class="product-section">
        <!-- Your shopping list here -->
        <div id="shopping-list-container" class="shopping-list-container">
          <h3>Shopping List</h3>
          <table id="shopping-list-table" class="shopping-list-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="shopping-list-body">
              <!-- Shopping list items will be inserted here -->
            </tbody>
          </table>
          <div class="shopping-list-summary">
            <p id="total-price" class="total-price">Total: $0.00</p>
            <button
              id="clear-list"
              onclick="clearShoppingList()"
              class="button button-danger"
            >
              Clear List
            </button>
          </div>
        </div>

        <!-- Confirm Transaction -->
        <button
          type="button button-primary"
          id="confirm-transaction"
          class="button button-primary"
        >
          Confirm Transaction
        </button>
      </section>

      <section class="supplier-section">
        <div class="supplier-info-section">
          <h2>Supplier Searchbar</h2>
          <!-- Your supplier search form here -->
          <div class="search-container">
            <form id="search-form-supplier" class="search-form">
              <input
                type="text"
                class="search-input"
                id="search-input-supplier"
                placeholder="Search for a supplier"
                autocomplete="off"
              />
              <button type="submit" id="search-btn-supplier" class="search-btn">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="23"
                  viewBox="0 0 22 23"
                  fill="none"
                >
                  <path
                    d="M16.4998 16.9997L13.2515 13.7513M13.2515 13.7513C13.7728 13.2299 14.1864 12.611 14.4686 11.9298C14.7508 11.2486 14.896 10.5184 14.896 9.7811C14.896 9.04376 14.7508 8.31364 14.4686 7.63243C14.1864 6.95121 13.7728 6.33225 13.2515 5.81087C12.7301 5.28949 12.1111 4.87592 11.4299 4.59375C10.7487 4.31158 10.0186 4.16635 9.28125 4.16635C8.54391 4.16635 7.81379 4.31158 7.13258 4.59375C6.45137 4.87592 5.8324 5.28949 5.31102 5.81087C4.25806 6.86384 3.6665 8.29197 3.6665 9.7811C3.6665 11.2702 4.25806 12.6984 5.31102 13.7513C6.36399 14.8043 7.79213 15.3958 9.28125 15.3958C10.7704 15.3958 12.1985 14.8043 13.2515 13.7513Z"
                    stroke="#5B5B5B"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </form>
            <div id="search-results-supplier" class="search-results hidden">
              <ul id="results-list-supplier"></ul>
            </div>
          </div>

          <!-- Your supplier details form here -->
          <form id="supplier-details-form" class="supplier-details-form">
            <!-- supplier Name -->
            <div class="form-group">
              <label for="supplierName">supplier Name</label>
              <input
                type="text"
                id="supplierName"
                name="supplierName"
                required
                readonly
              />
            </div>

            <!-- Product Quantity -->
            <div class="form-group">
              <label for="supplierAddress">supplier Adrress</label>
              <input
                type="text"
                id="supplierAddress"
                name="supplierAddress"
                required
                readonly
              />
            </div>

            <!-- supplier Phone -->
            <div class="form-group">
              <label for="supplierPhone">supplier Phone</label>
              <input
                type="text"
                id="supplierPhone"
                name="supplierPhone"
                required
                readonly
              />
            </div>

            <!--supplier Total Debt -->
            <div class="form-group">
              <label for="supplierDebt">supplier Debt</label>
              <input
                type="number"
                id="supplierDebt"
                name="supplierDebt"
                required
                readonly
              />
            </div>

            <!-- Submit Button -->
            <button type="submit" class="button button-secondary">
              Submit
            </button>
          </form>
        </div>

        <!-- Payment -->
        <div class="purchase-section">
          <h3>Purchase Details</h3>
          <form id="purchase-form" class="purchase-form">
            <div class="form-group">
              <label for="totalAmount">Total Amount</label>
              <input
                type="number"
                id="totalAmount"
                name="totalAmount"
                required
                readonly
              />
            </div>
            <div class="form-group">
              <label for="discount">Discount</label>
              <input
                type="number"
                id="discount"
                name="discount"
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="finalAmount">Final Amount</label>
              <input
                type="number"
                id="finalAmount"
                name="finalAmount"
                required
                readonly
              />
            </div>
            <div class="form-group">
              <label for="paymentAmount">Payment Amount</label>
              <input
                type="number"
                id="paymentAmount"
                name="paymentAmount"
                required
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="remainingDebt">New Total Debt</label>
              <input
                type="number"
                id="remainingDebt"
                name="remainingDebt"
                readonly
              />
            </div>
            <button type="submit" class="button button-secondary">
              Complete Purchase
            </button>
          </form>
        </div>
      </section>
    </main>

    <script src="../../../scripts/common/Searchbar.js"></script>
    <script src="../../../assets/js/modal.js"></script>
    <script type="module" src="buying.js"></script>

    <!-- Handle the creation of new product -->
    <script>
      document
        .getElementById("newProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault(); // Prevent the default form submission

          // Collect the product data
          const productDesignation =
            document.getElementById("productDesignation").value;
          const productTaxes =
            parseFloat(document.getElementById("productTaxes").value) || 0;
          const subunitsInUnit = parseInt(
            document.getElementById("subunitsInUnit").value
          );

          // Create the product data object
          const productData = {
            productName: productDesignation,
            taxes: productTaxes,
            subunitsInUnit: subunitsInUnit,
          };

          console.log("ProductData ", productData);

          try {
            const result = await window.productsAPI.createProduct(productData);

            if (result.success) {
              console.log("Product created successfully with ID:", result.id);
              document.getElementById("newProductForm").reset();
              document.getElementById("newProductModal").style.display = "none";
            } else {
              console.error("Failed to create product:", result.error);
            }
          } catch (error) {
            console.error("Error creating product:", error);
          }
        });
    </script>

    <!-- supplier form handler -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fetchParties = async (searchTerm) => {
          return await window.electronAPI.parties.searchParty(
            "supplier",
            searchTerm
          );
        };

        const onPartySelected = (selectedSupplier) => {
          console.log("Supplier selected:", selectedSupplier);
          // You can add custom behavior for what happens when a product is selected.
          // For example, you might want to fill another input field or redirect the user.
          displaySelectedSupplier(selectedSupplier);
        };

        // Form handler
        function displaySelectedSupplier(supplier) {
          // Get form input elements
          const supplierNameInput = document.getElementById("supplierName");
          const supplierAddressInput =
            document.getElementById("supplierAddress");
          const supplierPhoneInput = document.getElementById("supplierPhone");
          const supplierDebtInput = document.getElementById("supplierDebt");

          // Store the supplier ID in the data attribute
          supplierNameInput.dataset.supplierId = supplier.party_id;
          // Populate form inputs with selected product data
          supplierNameInput.value = supplier.name || "";
          supplierAddressInput.value = supplier.address || "";
          supplierPhoneInput.value = supplier.phone || "";
          supplierDebtInput.value = supplier.total_debt || 0.0;
        }

        // Create an instance of the Searchbar class
        const supplierSearchbar = new Searchbar(
          "search-input-supplier", // Input field ID
          "results-list-supplier", // Results list ID
          "search-form-supplier", // Search form ID
          "search-results-supplier", // Results div ID
          fetchParties, // Fetch function for searching products
          onPartySelected // Callback when a product is selected
        );
      });
    </script>

    <!-- The new product form implemnetaion -->
    <!-- <script>
      // Function to calculate total prices
      function calculateTotals() {
        const quantity =
          parseFloat(document.getElementById("quantity").value) || 0;
        const buyingPrice =
          parseFloat(document.getElementById("buyingPrice").value) || 0;
        const buyingTax =
          parseFloat(document.getElementById("buyingTax").value) || 0;
        const sellingPrice =
          parseFloat(document.getElementById("sellingPrice").value) || 0;
        const sellingTax =
          parseFloat(document.getElementById("sellingTax").value) || 0;

        const totalBuyingPrice = quantity * buyingPrice * (1 + buyingTax / 100);
        const totalSellingPrice =
          quantity * sellingPrice * (1 + sellingTax / 100);

        document.getElementById("totalBuyingPrice").value =
          totalBuyingPrice.toFixed(2);
        document.getElementById("totalSellingPrice").value =
          totalSellingPrice.toFixed(2);
      }

      // Add event listeners to input fields
      const inputFields = [
        "quantity",
        "buyingPrice",
        "buyingTax",
        "sellingPrice",
        "sellingTax",
      ];
      inputFields.forEach((fieldId) => {
        document
          .getElementById(fieldId)
          .addEventListener("input", calculateTotals);
      });

      // Placeholder function for adding to purchase list
      function addToPurchaseList() {
        // Implement your logic here
        alert("Product added to purchase list");
      }
    </script> -->
  </body>
</html>
