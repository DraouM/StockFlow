<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../../../assets/styles/main.css" />
    <link rel="stylesheet" href="selling.css" />
  </head>
  <body>
    <header>
      <!-- HTML -->
      <a href="../transactions.html" id="back-button"> back </a>

      <h1>Selling Page</h1>
    </header>

    <!-- CLIENT  -->
    <h2>Products Searchbar</h2>

    <div class="main-container">
      <div class="product-section">
        <!-- Your product search form here -->
        <div class="search-container">
          <form id="search-form" class="search-form">
            <input
              type="text"
              class="search-input"
              id="search-input"
              placeholder="Search for a Product"
              autocomplete="off"
            />
            <button type="submit" id="search-btn" class="search-btn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="23"
                viewBox="0 0 22 23"
                fill="none"
              >
                <path
                  d="M16.4998 16.9997L13.2515 13.7513M13.2515 13.7513C13.7728 13.2299 14.1864 12.611 14.4686 11.9298C14.7508 11.2486 14.896 10.5184 14.896 9.7811C14.896 9.04376 14.7508 8.31364 14.4686 7.63243C14.1864 6.95121 13.7728 6.33225 13.2515 5.81087C12.7301 5.28949 12.1111 4.87592 11.4299 4.59375C10.7487 4.31158 10.0186 4.16635 9.28125 4.16635C8.54391 4.16635 7.81379 4.31158 7.13258 4.59375C6.45137 4.87592 5.8324 5.28949 5.31102 5.81087C4.25806 6.86384 3.6665 8.29197 3.6665 9.7811C3.6665 11.2702 4.25806 12.6984 5.31102 13.7513C6.36399 14.8043 7.79213 15.3958 9.28125 15.3958C10.7704 15.3958 12.1985 14.8043 13.2515 13.7513Z"
                  stroke="#5B5B5B"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </form>
          <div id="search-results" class="search-results hidden">
            <ul id="results-list"></ul>
          </div>
        </div>

        <!-- Your product details form here -->
        <form id="product-details-form" class="product-details-form">
          <!-- Product Name -->
          <div class="form-group">
            <label for="productName">Product Name</label>
            <input
              type="text"
              id="productName"
              name="productName"
              required
              readonly
            />
            <small class="form-text">Enter the name of the product.</small>
          </div>

          <!-- Product Quantity -->
          <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" required />
            <small class="form-text">Enter the quantity of the product.</small>
          </div>

          <!-- Unit Price -->
          <div class="form-group">
            <label for="unitPrice">Unit Price</label>
            <input type="number" id="unitPrice" name="unitPrice" required />
            <small class="form-text">The price per unit of the product.</small>
          </div>

          <!-- Total Price (Quantity * Unit Price) -->
          <div class="form-group">
            <label for="totalPrice">Total Price</label>
            <input
              type="number"
              id="totalPrice"
              name="totalPrice"
              required
              readonly
            />
            <small class="form-text"
              >Total cost based on quantity and unit price.</small
            >
          </div>

          <!-- ADD to list Button -->
          <button
            type="button"
            onclick="addToShoppingList()"
            class="button button-secondary"
          >
            Add to List
          </button>
        </form>

        <!-- Your shopping list here -->
        <div id="shopping-list-container" class="shopping-list-container">
          <h3>Shopping List</h3>
          <table id="shopping-list-table" class="shopping-list-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="shopping-list-body">
              <!-- Shopping list items will be inserted here -->
            </tbody>
          </table>
          <div class="shopping-list-summary">
            <p id="total-price" class="total-price">Total: $0.00</p>
            <button id="clear-list" class="button button-danger">
              Clear List
            </button>
          </div>
        </div>

        <!-- Confirm Transaction -->
        <button
          type="button button-primary"
          id="confirm-transaction"
          class="button button-primary"
        >
          Confirm Transaction
        </button>
      </div>

      <div class="client-section">
        <div class="client-info-section">
          <h2>Clients Searchbar</h2>
          <!-- Your client search form here -->
          <div class="search-container">
            <form id="search-form-client" class="search-form">
              <input
                type="text"
                class="search-input"
                id="search-input-client"
                placeholder="Search for a Client"
                autocomplete="off"
              />
              <button type="submit" id="search-btn-client" class="search-btn">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="23"
                  viewBox="0 0 22 23"
                  fill="none"
                >
                  <path
                    d="M16.4998 16.9997L13.2515 13.7513M13.2515 13.7513C13.7728 13.2299 14.1864 12.611 14.4686 11.9298C14.7508 11.2486 14.896 10.5184 14.896 9.7811C14.896 9.04376 14.7508 8.31364 14.4686 7.63243C14.1864 6.95121 13.7728 6.33225 13.2515 5.81087C12.7301 5.28949 12.1111 4.87592 11.4299 4.59375C10.7487 4.31158 10.0186 4.16635 9.28125 4.16635C8.54391 4.16635 7.81379 4.31158 7.13258 4.59375C6.45137 4.87592 5.8324 5.28949 5.31102 5.81087C4.25806 6.86384 3.6665 8.29197 3.6665 9.7811C3.6665 11.2702 4.25806 12.6984 5.31102 13.7513C6.36399 14.8043 7.79213 15.3958 9.28125 15.3958C10.7704 15.3958 12.1985 14.8043 13.2515 13.7513Z"
                    stroke="#5B5B5B"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </form>
            <div id="search-results-client" class="search-results hidden">
              <ul id="results-list-client"></ul>
            </div>
          </div>

          <!-- Your client details form here -->
          <form id="client-details-form" class="client-details-form">
            <!-- Client Name -->
            <div class="form-group">
              <label for="clientName">Client Name</label>
              <input
                type="text"
                id="clientName"
                name="clientName"
                required
                readonly
              />
            </div>

            <!-- Product Quantity -->
            <div class="form-group">
              <label for="clientAddress">Client Adrress</label>
              <input
                type="text"
                id="clientAddress"
                name="clientAddress"
                required
                readonly
              />
            </div>

            <!-- Client Phone -->
            <div class="form-group">
              <label for="clientPhone">Client Phone</label>
              <input
                type="text"
                id="clientPhone"
                name="clientPhone"
                required
                readonly
              />
            </div>

            <!--Client Total Debt -->
            <div class="form-group">
              <label for="clientDebt">Client Debt</label>
              <input
                type="number"
                id="clientDebt"
                name="clientDebt"
                required
                readonly
              />
            </div>

            <!-- Submit Button -->
            <button type="submit" class="button button-secondary">
              Submit
            </button>
          </form>
        </div>

        <!-- Payment -->
        <div class="purchase-section">
          <h3>Purchase Details</h3>
          <form id="purchase-form" class="purchase-form">
            <div class="form-group">
              <label for="totalAmount">Total Amount</label>
              <input
                type="number"
                id="totalAmount"
                name="totalAmount"
                required
                readonly
              />
            </div>
            <div class="form-group">
              <label for="discount">Discount</label>
              <input
                type="number"
                id="discount"
                name="discount"
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="finalAmount">Final Amount</label>
              <input
                type="number"
                id="finalAmount"
                name="finalAmount"
                required
                readonly
              />
            </div>
            <div class="form-group">
              <label for="paymentAmount">Payment Amount</label>
              <input
                type="number"
                id="paymentAmount"
                name="paymentAmount"
                required
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="remainingDebt">New Total Debt</label>
              <input
                type="number"
                id="remainingDebt"
                name="remainingDebt"
                readonly
              />
            </div>
            <button type="submit" class="button button-secondary">
              Complete Purchase
            </button>
          </form>
        </div>
      </div>
    </div>

    <script src="selling.js"></script>
    <script src="../../../scripts/common/Searchbar.js"></script>

    <!-- Client form handler -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fetchParties = async (searchTerm) => {
          return await window.electronAPI.parties.searchParty(
            "client",
            searchTerm
          );
        };

        const onPartySelected = (selectedClient) => {
          console.log("Client selected:", selectedClient);
          // You can add custom behavior for what happens when a product is selected.
          // For example, you might want to fill another input field or redirect the user.
          displaySelectedClient(selectedClient);
        };

        // Form handler
        function displaySelectedClient(client) {
          // Get form input elements
          const clientNameInput = document.getElementById("clientName");
          const clientAddressInput = document.getElementById("clientAddress");
          const clientPhoneInput = document.getElementById("clientPhone");
          const clientDebtInput = document.getElementById("clientDebt");

          // Store the client ID in the data attribute
          clientNameInput.dataset.clientId = client.party_id;
          // Populate form inputs with selected product data
          clientNameInput.value = client.name || "";
          clientAddressInput.value = client.address || "";
          clientPhoneInput.value = client.phone || "";
          clientDebtInput.value = client.total_debt || 0.0;
        }

        // Create an instance of the Searchbar class
        const clientSearchbar = new Searchbar(
          "search-input-client", // Input field ID
          "results-list-client", // Results list ID
          "search-form-client", // Search form ID
          "search-results-client", // Results div ID
          fetchParties, // Fetch function for searching products
          onPartySelected // Callback when a product is selected
        );
      });
    </script>

    <!-- Purchase form handler -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const purchaseForm = document.getElementById("purchase-form");
        const totalAmountInput = document.getElementById("totalAmount");
        const discountInput = document.getElementById("discount");
        const finalAmountInput = document.getElementById("finalAmount");
        const paymentAmountInput = document.getElementById("paymentAmount");
        const remainingDebtInput = document.getElementById("remainingDebt");
        const clientDebtInput = document.getElementById("clientDebt");

        // Update final amount when discount changes
        discountInput.addEventListener("input", updateFinalAmount);

        // Update remaining debt when payment amount changes
        paymentAmountInput.addEventListener("input", updateRemainingDebt);

        // Handle form submission
        purchaseForm.addEventListener("submit", handlePurchaseSubmit);

        function updateFinalAmount() {
          const totalAmount = parseFloat(totalAmountInput.value) || 0;
          const discount = parseFloat(discountInput.value) || 0;
          const finalAmount = Math.max(totalAmount - discount, 0);

          console.log("FINAL AMount ", finalAmount);

          finalAmountInput.value = finalAmount.toFixed(2);
          updateRemainingDebt();
        }

        function updateRemainingDebt() {
          const finalAmount = parseFloat(finalAmountInput.value) || 0;
          const paymentAmount = parseFloat(paymentAmountInput.value) || 0;
          const currentDebt = parseFloat(clientDebtInput.value) || 0;
          const newDebt = currentDebt + (finalAmount - paymentAmount);
          remainingDebtInput.value = newDebt.toFixed(2);
        }

        function handlePurchaseSubmit(event) {
          event.preventDefault();

          const totalAmount = parseFloat(totalAmountInput.value);
          const discount = parseFloat(discountInput.value) || 0;
          const finalAmount = parseFloat(finalAmountInput.value);
          const paymentAmount = parseFloat(paymentAmountInput.value);
          const remainingDebt = parseFloat(remainingDebtInput.value);

          if (paymentAmount < finalAmount) {
            const confirmPurchase = confirm(
              "The payment amount is less than the final amount. This will increase the client's debt. Do you want to proceed?"
            );
            if (!confirmPurchase) {
              return;
            }
          }

          const purchaseDetails = {
            totalAmount,
            discount,
            finalAmount,
            paymentAmount,
            remainingDebt,
          };

          console.log("Purchase completed:", purchaseDetails);

          // Here you would typically send this data to your backend
          // For example:
          // sendPurchaseToBackend(purchaseDetails);

          // Update client debt and reset the form
          updateClientDebt(remainingDebt);
          resetPurchaseForm();
        }

        function resetPurchaseForm() {
          purchaseForm.reset();
          finalAmountInput.value = "0.00";
          remainingDebtInput.value = clientDebtInput.value;
          // Note: We're not resetting totalAmountInput here
        }

        function updateClientDebt(newDebt) {
          clientDebtInput.value = newDebt.toFixed(2);
          // You might want to update this in your client object or send to backend as well
        }

        // Function to set initial total amount (call this when updating shopping list)
        function setInitialTotalAmount(amount) {
          console.log("SETINITIAL ", amount);

          totalAmountInput.value = amount.toFixed(2);
          console.log("DONE");

          updateFinalAmount();
        }

        // Expose this function so it can be called from outside
        window.setInitialTotalAmount = setInitialTotalAmount;
      });
    </script>

    <!-- Confirm transaction -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const confirmButton = document.getElementById("confirm-transaction");
        confirmButton.addEventListener("click", confirmTransaction);

        function confirmTransaction() {
          // Get client details
          const clientId =
            document.getElementById("clientName").dataset.clientId; // Assuming you store the client ID in a data attribute
          const totalAmount = parseFloat(
            document.getElementById("finalAmount").value
          );
          const discount =
            parseFloat(document.getElementById("discount").value) || 0;

          // Get current date
          const currentDate = new Date().toISOString().split("T")[0]; // Format: YYYY-MM-DD

          // Create transaction object
          const transaction = {
            party_id: parseInt(clientId),
            total_amount: totalAmount,
            discount: discount,
            transaction_date: currentDate,
            transaction_type: "selling", // Assuming this is a selling transaction
            settled: 0,
            notes: "Transaction from web interface",
          };

          // Log the transaction to console
          console.log("New Transaction:", transaction);

          // Here you would typically send this data to your backend
          // For example:
          saveDataInDatabase(transaction);

          // Clear the shopping list and reset forms
          clearShoppingList();
          resetForms();
        }

        function clearShoppingList() {
          // Clear the shopping list table
          const shoppingListBody =
            document.getElementById("shopping-list-body");
          shoppingListBody.innerHTML = "";

          // Reset total price
          document.getElementById("total-price").textContent = "Total: $0.00";
        }

        function resetForms() {
          // Reset product form
          document.getElementById("product-details-form").reset();

          // Reset client form
          document.getElementById("client-details-form").reset();

          // Reset purchase form
          document.getElementById("purchase-form").reset();
        }

        async function saveDataInDatabase(newTransaction) {
          try {
            console.log("Transaction data to be saved:", newTransaction);

            // Validate transaction data
            const requiredFields = [
              "party_id",
              "total_amount",
              "transaction_date",
              "transaction_type",
            ];
            for (const field of requiredFields) {
              if (!(field in newTransaction)) {
                throw new Error(
                  `Missing required field in transaction data: ${field}`
                );
              }
            }

            // Create transaction
            const transactionId = await window.electronAPI.transactions.create(
              newTransaction
            );
            console.log(
              "Transaction created successfully with ID:",
              transactionId
            );

            // Get current shopping list
            const currentShoppingList = getShoppingList();
            console.log("Current Shopping List:", currentShoppingList);

            // Prepare the shopping list with updated quantities
            const updatedShoppingList = currentShoppingList.map((item) => ({
              productId: item.productId,
              newStockQuantity: item.stockQuantity - item.quantityPurchased,
            }));

            console.log("Updated Shopping List:", updatedShoppingList);

            // Update product quantities
            await updateProductsQuantity(updatedShoppingList);
            console.log("Purchase completed and product quantities updated");

            // Return the transaction ID
            return transactionId;
          } catch (error) {
            console.error("Error in saveDataInDatabase:", error);
            throw error; // Re-throw the error for the caller to handle
          }
        }

        async function updateProductsQuantity(shoppingList) {
          try {
            for (const item of shoppingList) {
              console.log("Item ", item);

              const updates = {
                stock_quantity: item.newStockQuantity,
              };

              console.log("Product ", item.productId, updates);

              await window.electronAPI.products.update(item.productId, updates);
              console.log(`Updated quantity for product ${item.productId}`);
            }
            console.log("All product quantities updated successfully");
          } catch (error) {
            console.error("Error updating product quantities:", error);
            throw error;
          }
        }
      });
    </script>
  </body>
</html>
