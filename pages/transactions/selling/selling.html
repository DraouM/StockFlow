<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../../../assets/styles/main.css" />
    <link rel="stylesheet" href="selling.css" />

    <style>
      /* Table Styles */
      .table_container {
        width: 95%;
        max-height: calc(89% - 1.6rem);
        background-color: #fffb;
        margin: 0.8rem auto;
        border-radius: 0.6rem;
        overflow: auto;
        overflow: overlay;
      }

      .table_container::-webkit-scrollbar {
        width: 0.5rem;
        height: 0.5rem;
      }

      .table_container::-webkit-scrollbar-thumb {
        border-radius: 0.5rem;
        background-color: #0004;
        visibility: hidden;
      }

      .table_container:hover::-webkit-scrollbar-thumb {
        visibility: visible;
      }

      table {
        width: 100%;
      }

      table,
      th,
      td {
        border-collapse: collapse;
        padding: 0.5rem;
        text-align: right;
      }

      thead th {
        position: sticky;
        top: 0;
        left: 0;
        background-color: #d5d1defe;
        cursor: pointer;
        text-transform: capitalize;
      }

      tbody tr:nth-child(even) {
        background-color: #0000000b;
      }

      tbody tr {
        --delay: 0.1s;
        transition: 0.5s ease-in-out var(--delay), background-color 0s;
      }

      tbody tr.hide {
        opacity: 0;
        transform: translateX(100%);
      }

      tbody tr:hover {
        background-color: #fff6 !important;
      }

      tbody tr td,
      tbody tr td p {
        transition: 0.2s ease-in-out;
      }

      tbody tr.hide td,
      tbody tr.hide td p {
        padding: 0;
        font: 0 / 0 sans-serif;
        transition: 0.2s ease-in-out 0.5s;
      }

      thead th span.icon-arrow {
        display: inline-block;
        width: 1.3rem;
        height: 1.3rem;
        border-radius: 50%;
        border: 1.4px solid transparent;

        text-align: center;
        font-size: 1rem;

        margin-left: 0.5rem;
        transition: 0.2s ease-in-out;
      }

      thead th:hover span.icon-arrow {
        border: 1.4px solid #6c00bd;
      }

      thead th:hover {
        color: #6c00bd;
      }

      thead th.active span.icon-arrow {
        background-color: #6c00bd;
        color: #fff;
      }

      thead th.asc span.icon-arrow {
        transform: rotate(180deg);
      }

      thead th.active,
      tbody td.active {
        color: #6c00bd;
      }

      /* first row */
      .number-circle {
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #adbdc7;
        text-align: center;
        line-height: 30px;
        font-size: 16px;
      }

      /* Quantity Column Styling */
      .quantity {
        display: flex;
        align-items: center;
        /* Center-align both parts vertically */
        justify-content: flex-end;
        /* Space between main and sub-quantity */
        gap: 8px;
      }

      /* Main Quantity */
      .main-quantity {
        font-size: 16px;
        font-weight: normal;
        color: #333;
      }

      /* Sub Quantity */
      .sub-quantity {
        font-size: 12px;
        font-weight: bold;
        color: red;
        border: 1px solid red;
        background-color: white;
        /* Highlighted background */
        padding: 2px 4px;
        border-radius: 5px;
        /* Rounded corners */
      }
    </style>
  </head>
  <body>
    <header>
      <!-- HTML -->
      <a href="../transactions.html" id="back-button"> back </a>

      <h1>Selling Page</h1>

      <a href="../buying/buying.html" class="button"> Buying </a>
    </header>

    <!-- CLIENT  -->
    <h2>Shopping</h2>

    <!-- <div id="client-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal-btn">&times;</span>
        <h2 class="modal-title">Select Client</h2>
        <div class="modal-body">
          <div class="search-container">
            <input
              type="text"
              id="search-input-client"
              placeholder="Search for a Client"
              autocomplete="off"
            />
            <div id="search-results-client" class="search-results hidden">
              <ul id="results-list-client"></ul>
            </div>
          </div>
          <form id="client-details-form" class="client-details-form">
            <div class="form-group">
              <label for="clientName">Client Name</label>
              <input type="text" id="clientName" name="clientName" readonly />
            </div>
            <div class="form-group">
              <label for="clientAddress">Client Address</label>
              <input
                type="text"
                id="clientAddress"
                name="clientAddress"
                readonly
              />
            </div>
            <div class="form-group">
              <label for="clientPhone">Client Phone</label>
              <input type="text" id="clientPhone" name="clientPhone" readonly />
            </div>
            <div class="form-group">
              <label for="clientDebt">Client Debt</label>
              <input type="number" id="clientDebt" name="clientDebt" readonly />
            </div>
          </form>
        </div>
      </div>
    </div> -->

    <button id="open-modal-btn" class="button">Add New Product</button>

    <div id="product-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal-btn">&times;</span>
        <h2 class="modal-title">Add Product</h2>
        <div class="modal-body">
          <form id="selling-form" data-operation="add">
            <div class="search-container">
              <div id="search-product-form" class="search-form">
                <input
                  type="text"
                  class="search-input"
                  id="search-product-input"
                  placeholder="Search for a Product"
                  autocomplete="off"
                />
                <button type="submit" id="search-btn" class="search-btn">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="23"
                    viewBox="0 0 22 23"
                    fill="none"
                  >
                    <path
                      d="M16.4998 16.9997L13.2515 13.7513M13.2515 13.7513C13.7728 13.2299 14.1864 12.611 14.4686 11.9298C14.7508 11.2486 14.896 10.5184 14.896 9.7811C14.896 9.04376 14.7508 8.31364 14.4686 7.63243C14.1864 6.95121 13.7728 6.33225 13.2515 5.81087C12.7301 5.28949 12.1111 4.87592 11.4299 4.59375C10.7487 4.31158 10.0186 4.16635 9.28125 4.16635C8.54391 4.16635 7.81379 4.31158 7.13258 4.59375C6.45137 4.87592 5.8324 5.28949 5.31102 5.81087C4.25806 6.86384 3.6665 8.29197 3.6665 9.7811C3.6665 11.2702 4.25806 12.6984 5.31102 13.7513C6.36399 14.8043 7.79213 15.3958 9.28125 15.3958C10.7704 15.3958 12.1985 14.8043 13.2515 13.7513Z"
                      stroke="#5B5B5B"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </div>
              <div id="search-product-results" class="search-results hidden">
                <ul id="product-results-list"></ul>
              </div>
            </div>

            <div class="form-group">
              <label for="productId">ID</label>
              <input type="text" id="productId" name="productId" />
            </div>
            <div class="form-group">
              <label for="productName">Product Name</label>
              <input type="text" id="productName" name="productName" />
            </div>

            <div class="form-group quantity-group">
              <!-- <label>Quantity</label> -->
              <div class="quantity-row">
                <div class="quantity-col">
                  <label for="quantity">Quantity</label>
                  <input type="text" id="quantity" name="quantity" />
                </div>
                <span>* <span id="quantityUnit">01</span> =</span>
                <div class="quantity-col">
                  <label for="subUnits">Sub Units</label>
                  <input type="text" id="subUnits" name="subUnits" />
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="unitPrice">Price</label>
              <div class="price-row">
                <input type="text" id="unitPrice" name="unitPrice" />
                <span>* <span id="subunits-span">00</span> =</span>
                <input type="text" id="subTotal" name="subTotal" readonly />
              </div>
            </div>

            <div class="form-actions">
              <button type="button" id="clear-form" class="button btn-clear">
                CLEAR
              </button>
              <button
                type="submit"
                id="add-to-list"
                class="button button-primary btn-add"
              >
                Add to List
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Shopping List -->
    <section class="table_container">
      <table id="shopping-list">
        <thead>
          <tr>
            <th>Num</th>
            <th>Product Name</th>
            <th>Quantity</th>
            <th>Units</th>
            <th>Unit Price</th>
            <th>Sub Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Table Rows -->
          <tr>
            <td><span class="number-circle">1</span></td>
            <td>Product A</td>
            <td class="quantity">
              <span class="main-quantity">5 & 6</span>
              <span class="sub-quantity highlight">08</span>
            </td>
            <td>46</td>
            <td>23.26</td>
            <td>1069.96</td>
            <td>
              <button class="edit button button-secondary button-small">
                EDIT
              </button>
              <button class="del button button-danger button-small">DEL</button>
            </td>
          </tr>
          <tr>
            <td><span class="number-circle">2</span></td>
            <td>Product A</td>
            <td class="quantity">
              <span class="main-quantity">3 & 8</span>
              <span class="sub-quantity highlight">10</span>
            </td>
            <td>38</td>
            <td>126.50</td>
            <td>4807.00</td>
            <td>
              <button class="edit button button-secondary button-small">
                EDIT
              </button>
              <button class="del button button-danger button-small">DEL</button>
            </td>
          </tr>
          <tr>
            <td><span class="number-circle">2</span></td>
            <td>Product C</td>
            <td class="quantity">
              <span class="main-quantity">4</span>
              <span class="sub-quantity highlight">01</span>
            </td>
            <td>4</td>
            <td>326.50</td>
            <td>1302.00</td>
            <td>
              <button class="edit button button-secondary button-small">
                EDIT
              </button>
              <button class="del button button-danger button-small">DEL</button>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td class="total-price" colspan="4" class="total-label">Total</td>
            <td id="total-price" class="total-price" colspan="2">
              12,548,896 DA
            </td>
          </tr>
        </tfoot>
      </table>
    </section>
    <button
      onclick="confirmOrder()"
      class="button button-primary button-medium"
    >
      CONFIRM ORDER
    </button>

    <div class="main-container">
      <div class="product-section">
        <!-- Your product details form here -->

        <!-- Your shopping list here -->
        <div id="shopping-list-container" class="shopping-list-container">
          <h3>Shopping List</h3>
          <table id="shopping-list-table" class="shopping-list-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="shopping-list-body">
              <!-- Shopping list items will be inserted here -->
            </tbody>
          </table>
          <div class="shopping-list-summary">
            <p id="total-price" class="total-price">Total: $0.00</p>
            <button id="clear-list" class="button button-danger">
              Clear List
            </button>
          </div>
        </div>

        <!-- Confirm Transaction -->
        <button
          type="button button-primary"
          id="confirm-transaction"
          class="button button-primary"
        >
          Confirm Transaction
        </button>
      </div>

      <div class="client-section">
        <div class="client-info-section">
          <h2>Clients Searchbar</h2>
          <!-- Your client search form here -->
          <div class="search-container">
            <form id="search-form-client" class="search-form">
              <input
                type="text"
                class="search-input"
                id="search-input-client"
                placeholder="Search for a Client"
                autocomplete="off"
              />
              <button type="submit" id="search-btn-client" class="search-btn">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="23"
                  viewBox="0 0 22 23"
                  fill="none"
                >
                  <path
                    d="M16.4998 16.9997L13.2515 13.7513M13.2515 13.7513C13.7728 13.2299 14.1864 12.611 14.4686 11.9298C14.7508 11.2486 14.896 10.5184 14.896 9.7811C14.896 9.04376 14.7508 8.31364 14.4686 7.63243C14.1864 6.95121 13.7728 6.33225 13.2515 5.81087C12.7301 5.28949 12.1111 4.87592 11.4299 4.59375C10.7487 4.31158 10.0186 4.16635 9.28125 4.16635C8.54391 4.16635 7.81379 4.31158 7.13258 4.59375C6.45137 4.87592 5.8324 5.28949 5.31102 5.81087C4.25806 6.86384 3.6665 8.29197 3.6665 9.7811C3.6665 11.2702 4.25806 12.6984 5.31102 13.7513C6.36399 14.8043 7.79213 15.3958 9.28125 15.3958C10.7704 15.3958 12.1985 14.8043 13.2515 13.7513Z"
                    stroke="#5B5B5B"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </form>
            <div id="search-results-client" class="search-results hidden">
              <ul id="results-list-client"></ul>
            </div>
          </div>

          <!-- Your client details form here -->
          <form id="client-details-form" class="client-details-form">
            <!-- Client Name -->
            <div class="form-group">
              <label for="clientName">Client Name</label>
              <input
                type="text"
                id="clientName"
                name="clientName"
                required
                readonly
              />
            </div>

            <!-- Product Quantity -->
            <div class="form-group">
              <label for="clientAddress">Client Adrress</label>
              <input
                type="text"
                id="clientAddress"
                name="clientAddress"
                required
                readonly
              />
            </div>

            <!-- Client Phone -->
            <div class="form-group">
              <label for="clientPhone">Client Phone</label>
              <input
                type="text"
                id="clientPhone"
                name="clientPhone"
                required
                readonly
              />
            </div>

            <!--Client Total Debt -->
            <div class="form-group">
              <label for="clientDebt">Client Debt</label>
              <input
                type="number"
                id="clientDebt"
                name="clientDebt"
                required
                readonly
              />
            </div>

            <!-- Submit Button -->
            <button type="submit" class="button button-secondary">
              Submit
            </button>
          </form>
        </div>

        <!-- Payment -->
        <div class="purchase-section">
          <h3>Purchase Details</h3>
          <form id="purchase-form" class="purchase-form">
            <div class="form-group">
              <label for="totalAmount">Total Amount</label>
              <input
                type="number"
                id="totalAmount"
                name="totalAmount"
                required
                readonly
              />
            </div>
            <div class="form-group">
              <label for="discount">Discount</label>
              <input
                type="number"
                id="discount"
                name="discount"
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="finalAmount">Final Amount</label>
              <input
                type="number"
                id="finalAmount"
                name="finalAmount"
                required
                readonly
              />
            </div>
            <div class="form-group">
              <label for="paymentAmount">Payment Amount</label>
              <input
                type="number"
                id="paymentAmount"
                name="paymentAmount"
                required
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="remainingDebt">New Total Debt</label>
              <input
                type="number"
                id="remainingDebt"
                name="remainingDebt"
                readonly
              />
            </div>
            <button type="submit" class="button button-secondary">
              Complete Purchase
            </button>
          </form>
        </div>
      </div>
    </div>

    <script type="module" src="selling2.js"></script>
    <script src="../../../scripts/common/Searchbar.js"></script>

    <!-- Client form handler -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fetchParties = async (searchTerm) => {
          console.log({ searchTerm });

          return await window.partiesAPI.searchParties({
            searchTerm: searchTerm,
            type: "customer", // You can specify a type if needed, e.g., "customer"
            page: 1, // Set the page number as needed
            limit: 50, // Set the limit for pagination
          });
        };

        const onPartySelected = (selectedClient) => {
          console.log("Client selected:", selectedClient);
          // You can add custom behavior for what happens when a product is selected.
          // For example, you might want to fill another input field or redirect the user.
          displaySelectedClient(selectedClient);
        };

        // Form handler
        function displaySelectedClient(client) {
          // Get form input elements
          const clientNameInput = document.getElementById("clientName");
          const clientAddressInput = document.getElementById("clientAddress");
          const clientPhoneInput = document.getElementById("clientPhone");
          const clientDebtInput = document.getElementById("clientDebt");

          // Store the client ID in the data attribute
          clientNameInput.dataset.clientId = client.party_id;
          // Populate form inputs with selected product data
          clientNameInput.value = client.name || "";
          clientAddressInput.value = client.address || "";
          clientPhoneInput.value = client.phone || "";
          clientDebtInput.value = client.total_debt || 0.0;
        }

        // Create an instance of the Searchbar class
        const clientSearchbar = new Searchbar(
          "search-input-client", // Input field ID
          "results-list-client", // Results list ID
          "search-form-client", // Search form ID
          "search-results-client", // Results div ID
          fetchParties, // Fetch function for searching products
          onPartySelected // Callback when a product is selected
        );
      });
    </script>

    <!-- Purchase form handler -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const purchaseForm = document.getElementById("purchase-form");
        const totalAmountInput = document.getElementById("totalAmount");
        const discountInput = document.getElementById("discount");
        const finalAmountInput = document.getElementById("finalAmount");
        const paymentAmountInput = document.getElementById("paymentAmount");
        const remainingDebtInput = document.getElementById("remainingDebt");
        const clientDebtInput = document.getElementById("clientDebt");

        // Update final amount when discount changes
        discountInput.addEventListener("input", updateFinalAmount);

        // Update remaining debt when payment amount changes
        paymentAmountInput.addEventListener("input", updateRemainingDebt);

        // Handle form submission
        purchaseForm.addEventListener("submit", handlePurchaseSubmit);

        function updateFinalAmount() {
          const totalAmount = parseFloat(totalAmountInput.value) || 0;
          const discount = parseFloat(discountInput.value) || 0;
          const finalAmount = Math.max(totalAmount - discount, 0);

          console.log("FINAL AMount ", finalAmount);

          finalAmountInput.value = finalAmount.toFixed(2);
          updateRemainingDebt();
        }

        function updateRemainingDebt() {
          const finalAmount = parseFloat(finalAmountInput.value) || 0;
          const paymentAmount = parseFloat(paymentAmountInput.value) || 0;
          const currentDebt = parseFloat(clientDebtInput.value) || 0;
          const newDebt = currentDebt + (finalAmount - paymentAmount);
          remainingDebtInput.value = newDebt.toFixed(2);
        }

        function handlePurchaseSubmit(event) {
          event.preventDefault();

          const totalAmount = parseFloat(totalAmountInput.value);
          const discount = parseFloat(discountInput.value) || 0;
          const finalAmount = parseFloat(finalAmountInput.value);
          const paymentAmount = parseFloat(paymentAmountInput.value);
          const remainingDebt = parseFloat(remainingDebtInput.value);

          if (paymentAmount < finalAmount) {
            const confirmPurchase = confirm(
              "The payment amount is less than the final amount. This will increase the client's debt. Do you want to proceed?"
            );
            if (!confirmPurchase) {
              return;
            }
          }

          const purchaseDetails = {
            totalAmount,
            discount,
            finalAmount,
            paymentAmount,
            remainingDebt,
          };

          console.log("Purchase completed:", purchaseDetails);

          // Here you would typically send this data to your backend
          // For example:
          // sendPurchaseToBackend(purchaseDetails);

          // Update client debt and reset the form
          updateClientDebt(remainingDebt);
          resetPurchaseForm();
        }

        function resetPurchaseForm() {
          purchaseForm.reset();
          finalAmountInput.value = "0.00";
          remainingDebtInput.value = clientDebtInput.value;
          // Note: We're not resetting totalAmountInput here
        }

        function updateClientDebt(newDebt) {
          clientDebtInput.value = newDebt.toFixed(2);
          // You might want to update this in your client object or send to backend as well
        }

        // Function to set initial total amount (call this when updating shopping list)
        function setInitialTotalAmount(amount) {
          console.log("SETINITIAL ", amount);

          totalAmountInput.value = amount.toFixed(2);
          console.log("DONE");

          updateFinalAmount();
        }

        // Expose this function so it can be called from outside
        window.setInitialTotalAmount = setInitialTotalAmount;
      });
    </script>

    <!-- Confirm transaction -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const confirmButton = document.getElementById("confirm-transaction");
        confirmButton.addEventListener("click", confirmTransaction);

        function confirmTransaction() {
          // Get client details
          const clientId =
            document.getElementById("clientName").dataset.clientId; // Assuming you store the client ID in a data attribute
          const totalAmount = parseFloat(
            document.getElementById("finalAmount").value
          );
          const discount =
            parseFloat(document.getElementById("discount").value) || 0;

          // Get current date
          const currentDate = new Date().toISOString().split("T")[0]; // Format: YYYY-MM-DD

          // Create transaction object
          const transaction = {
            party_id: parseInt(clientId),
            total_amount: totalAmount,
            discount: discount,
            transaction_date: currentDate,
            transaction_type: "selling", // Assuming this is a selling transaction
            settled: 0,
            notes: "Transaction from web interface",
          };

          // Log the transaction to console
          console.log("New Transaction:", transaction);

          // Here you would typically send this data to your backend
          // For example:
          saveDataInDatabase(transaction);

          // Clear the shopping list and reset forms
          clearShoppingList();
          resetForms();
        }

        function clearShoppingList() {
          // Clear the shopping list table
          const shoppingListBody =
            document.getElementById("shopping-list-body");
          shoppingListBody.innerHTML = "";

          // Reset total price
          document.getElementById("total-price").textContent = "Total: $0.00";
        }

        function resetForms() {
          // Reset product form
          document.getElementById("product-details-form").reset();

          // Reset client form
          document.getElementById("client-details-form").reset();

          // Reset purchase form
          document.getElementById("purchase-form").reset();
        }

        async function saveDataInDatabase(newTransaction) {
          try {
            console.log("Transaction data to be saved:", newTransaction);

            // Validate transaction data
            const requiredFields = [
              "party_id",
              "total_amount",
              "transaction_date",
              "transaction_type",
            ];
            for (const field of requiredFields) {
              if (!(field in newTransaction)) {
                throw new Error(
                  `Missing required field in transaction data: ${field}`
                );
              }
            }

            // Create transaction
            const transactionId = await window.electronAPI.transactions.create(
              newTransaction
            );
            console.log(
              "Transaction created successfully with ID:",
              transactionId
            );

            // Get current shopping list
            const currentShoppingList = getShoppingList();
            console.log("Current Shopping List:", currentShoppingList);

            // Prepare the shopping list with updated quantities
            const updatedShoppingList = currentShoppingList.map((item) => ({
              productId: item.productId,
              newStockQuantity: item.stockQuantity - item.quantityPurchased,
            }));

            console.log("Updated Shopping List:", updatedShoppingList);

            // Update product quantities
            await updateProductsQuantity(updatedShoppingList);
            console.log("Purchase completed and product quantities updated");

            // Return the transaction ID
            return transactionId;
          } catch (error) {
            console.error("Error in saveDataInDatabase:", error);
            throw error; // Re-throw the error for the caller to handle
          }
        }

        async function updateProductsQuantity(shoppingList) {
          try {
            for (const item of shoppingList) {
              console.log("Item ", item);

              const updates = {
                stock_quantity: item.newStockQuantity,
              };

              console.log("Product ", item.productId, updates);

              await window.electronAPI.products.update(item.productId, updates);
              console.log(`Updated quantity for product ${item.productId}`);
            }
            console.log("All product quantities updated successfully");
          } catch (error) {
            console.error("Error updating product quantities:", error);
            throw error;
          }
        }
      });
    </script>

    <!-- Porduct Form Handler -->
    <script>
      const UtilityHelpers = {
        // Format number to 2 decimal places and add thousands separator
        formatNumber(number) {
          return number.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        },

        // Parse a number from a formatted string (removes non-numeric chars except decimal)
        parseNumber(str) {
          const cleanStr = str.replace(/[^\d.-]/g, "");
          const number = parseFloat(cleanStr);
          return isNaN(number) ? 0 : number;
        },

        // Validate if string contains only numbers, spaces, ampersand
        isValidQuantityFormat(str) {
          return /^\d+(?:\s*&\s*\d+)?$/.test(str.trim());
        },

        // Validate if string is a valid positive number
        isValidPrice(str) {
          const number = this.parseNumber(str);
          return number >= 0;
        },
      };

      const QuantityPriceManager = {
        // Store DOM elements and values
        elements: {
          quantityInput: null,
          subUnitInput: null,
          subUnitsSpan: null,
          priceInput: null,
          subTotalInput: null,
          quantityUnitSpan: null,
        },

        // Initialize the manager
        init() {
          // Get all required elements
          this.elements = {
            quantityInput: document.getElementById("quantity"),
            subUnitInput: document.getElementById("subUnits"),
            subUnitsSpan: document.getElementById("subunits-span"),
            priceInput: document.getElementById("unitPrice"),
            subTotalInput: document.getElementById("subTotal"),
            quantityUnitSpan: document.getElementById("quantityUnit"),
          };

          // Validate that all elements exist
          for (const [key, element] of Object.entries(this.elements)) {
            if (!element && key !== "quantityUnit") {
              console.error(`Required element ${key} not found`);
              return false;
            }
          }

          this.setupEventListeners();
          this.initializeValues();
          return true;
        },

        // Fetch the latest value of quantityUnit
        getQuantityUnit() {
          return parseInt(this.elements.quantityUnitSpan.textContent, 10);
        },

        // Set up all event listeners
        setupEventListeners() {
          // Quantity input handler
          this.elements.quantityInput.addEventListener("input", (e) => {
            this.handleQuantityInput(e.target.value);
          });

          // Price input handler
          this.elements.priceInput.addEventListener("input", (e) => {
            this.handlePriceInput(e.target.value);
          });

          // Handle blur events for formatting
          this.elements.quantityInput.addEventListener("blur", () => {
            this.formatQuantityDisplay();
          });

          this.elements.priceInput.addEventListener("blur", () => {
            this.formatPriceDisplay();
          });

          // Add space and tab key handlers for quantity input
          this.elements.quantityInput.addEventListener("keydown", (e) => {
            // Check if the pressed key is Space or Tab
            if (e.key === " " || e.key === "Tab") {
              const value = e.target.value.trim();

              // Only proceed if there's no & already and the value is a valid number
              if (!value.includes("&") && /^\d+$/.test(value)) {
                e.preventDefault(); // Prevent default space/tab behavior
                this.elements.quantityInput.value = value + " & ";

                // If it was a tab key, keep focus in the input
                if (e.key === "Tab") {
                  const cursorPosition =
                    this.elements.quantityInput.value.length;
                  this.elements.quantityInput.setSelectionRange(
                    cursorPosition,
                    cursorPosition
                  );
                }
              }
            }
          });
          // Add handler for sub-unit input
          this.elements.subUnitInput.addEventListener("input", (e) => {
            const subUnits = parseInt(e.target.value);
            if (!isNaN(subUnits)) {
              const quantityStr = this.convertSubUnitsToQuantity(subUnits);
              this.elements.quantityInput.value = quantityStr;
              this.elements.subUnitsSpan.textContent = subUnits;
              this.updateTotalPrice();
            }
          });
        },

        // Initialize starting values
        initializeValues() {
          if (this.elements.quantityInput.value) {
            this.handleQuantityInput(this.elements.quantityInput.value);
          }
          if (this.elements.priceInput.value) {
            this.handlePriceInput(this.elements.priceInput.value);
          }
        },

        // Handle quantity input changes
        handleQuantityInput(value) {
          const isValid = UtilityHelpers.isValidQuantityFormat(value);
          this.toggleInputError(this.elements.quantityInput, !isValid);

          if (isValid) {
            const totalSubUnits = this.calculateTotalSubUnits(value);
            // Update both sub-unit displays
            this.updateSubUnits(totalSubUnits);
            this.updateTotalPrice();

            // If the input doesn't match the calculated format, update it
            const calculatedQuantity =
              this.convertSubUnitsToQuantity(totalSubUnits);
            if (value.trim() !== calculatedQuantity) {
              this.elements.quantityInput.value = calculatedQuantity;
            }
          } else {
            this.updateSubUnits("");
            this.updateTotalPrice();
          }
        },
        // Handle price input changes
        handlePriceInput(value) {
          const isValid = UtilityHelpers.isValidPrice(value);
          this.toggleInputError(this.elements.priceInput, !isValid);

          if (isValid) {
            this.updateTotalPrice();
          } else {
            this.elements.subTotalInput.value = "";
          }
        },

        // Calculate total sub-units from quantity string
        calculateTotalSubUnits(quantityStr) {
          const cleaned = quantityStr.trim().replace(/\s+/g, " ");

          if (cleaned.includes("&")) {
            const [units, subUnits] = cleaned.split("&").map((part) => {
              const num = parseInt(part.trim(), 10);
              return isNaN(num) ? 0 : num;
            });

            // Validate sub-units don't exceed unit size
            const validSubUnits =
              subUnits >= this.getQuantityUnit()
                ? this.getQuantityUnit() - 1
                : subUnits;

            return units * this.getQuantityUnit() + validSubUnits;
          }

          const units = parseInt(cleaned, 10);
          return isNaN(units) ? 0 : units * this.getQuantityUnit();
        },

        // Convert sub-units back to quantity string
        convertSubUnitsToQuantity(subUnits) {
          console.log("Subunits ", subUnits, this.getQuantityUnit());

          if (!subUnits) return "0";

          const units = Math.floor(subUnits / this.getQuantityUnit());
          const remainingSubUnits = subUnits % this.getQuantityUnit();

          console.log("Check this ", units, remainingSubUnits);

          // If we only have sub-units (less than one full unit)
          if (units === 0) {
            return `0 & ${remainingSubUnits}`;
          }

          // If we have exact units (no remaining sub-units)
          if (remainingSubUnits === 0) {
            return `${units}`;
          }

          // If we have both units and sub-units
          return `${units} & ${remainingSubUnits}`;
        },

        // Update sub-units in both locations
        updateSubUnits(value) {
          this.elements.subUnitInput.value = value;
          this.elements.subUnitsSpan.textContent = value;
        },

        // Calculate and update total price
        updateTotalPrice() {
          const price = UtilityHelpers.parseNumber(
            this.elements.priceInput.value
          );
          const subUnits =
            parseInt(this.elements.subUnitsSpan.textContent) || 0;
          const total = price * subUnits;

          this.elements.subTotalInput.value =
            UtilityHelpers.formatNumber(total);
        },

        // Format quantity input on blur
        formatQuantityDisplay() {
          const value = this.elements.quantityInput.value.trim();
          if (UtilityHelpers.isValidQuantityFormat(value)) {
            const parts = value.includes("&") ? value.split("&") : [value];
            const formatted = parts.map((part) => part.trim()).join(" & ");
            this.elements.quantityInput.value = formatted;
          }
        },

        // Format price input on blur
        formatPriceDisplay() {
          const value = this.elements.priceInput.value;
          const number = UtilityHelpers.parseNumber(value);
          if (number >= 0) {
            this.elements.priceInput.value =
              UtilityHelpers.formatNumber(number);
          }
        },

        // Toggle error state on inputs
        toggleInputError(element, isError) {
          if (isError) {
            element.classList.add("error");
          } else {
            element.classList.remove("error");
          }
        },

        // Get current values (for form submission)
        getValues() {
          return {
            quantity: this.elements.quantityInput.value,
            subUnits: parseInt(this.elements.subUnitInput.value) || 0,
            unitPrice: UtilityHelpers.parseNumber(
              this.elements.priceInput.value
            ),
            totalPrice: UtilityHelpers.parseNumber(
              this.elements.subTotalInput.value
            ),
          };
        },
      };

      // Initialize when document loads
      document.addEventListener("DOMContentLoaded", () => {
        QuantityPriceManager.init();
      });
    </script>
  </body>
</html>
